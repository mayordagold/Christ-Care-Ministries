{% extends 'base.html' %}

{% block title %}Attendance - Church Tracker{% endblock %}

{% block content %}
  <h2>Attendance Entry</h2>
  <p>Welcome {{ current_user.name }} ({{ current_user.role }})</p>
  <a href="{{ url_for('dashboard.view_dashboard') }}">Back to Dashboard</a>

  {% if message %}
      <p style="color:green;">{{ message }}</p>
  {% endif %}

  <form method="POST">
      {{ form.hidden_tag() }}

      <div class="mb-3">
        <label class="form-label">{{ form.date.label.text }}</label>
        {{ form.date(class_='form-control', type='date', id='date_input') }}
        {{ render_errors(form.date) }}
      </div>

      <div class="mb-3">
        <label class="form-label">{{ form.service_type.label.text }}</label>
        {{ form.service_type(class_='form-control', id='service_type') }}
        {{ render_errors(form.service_type) }}
      </div>

      <div class="row g-3 mb-3">
        <div class="col-sm-4">
          <label class="form-label">{{ form.male.label.text }}</label>
          {{ form.male(class_='form-control', type='number', min='0', value='0', id='male') }}
          {{ render_errors(form.male) }}
        </div>
        <div class="col-sm-4">
          <label class="form-label">{{ form.female.label.text }}</label>
          {{ form.female(class_='form-control', type='number', min='0', value='0', id='female') }}
          {{ render_errors(form.female) }}
        </div>
        <div class="col-sm-4">
          <label class="form-label">{{ form.children.label.text }}</label>
          {{ form.children(class_='form-control', type='number', min='0', value='0', id='children') }}
          {{ render_errors(form.children) }}
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Total</label>
        <input id="total" class="form-control" type="number" readonly value="0">
      </div>

      <button type="submit" class="btn btn-primary">Save Attendance</button>
  </form>

      <hr>
      <h4>Recent Attendance</h4>
      {% if recent_attendance %}
        <div class="table-responsive">
        <table class="table table-sm table-hover align-middle">
          <thead>
            <tr>
              <th>Date</th>
              <th>Service</th>
              <th>Male</th>
              <th>Female</th>
              <th>Children</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            {% for a in recent_attendance %}
            <tr>
              <td>{{ a['date'] }}</td>
              <td>{{ a['service_type'] }}</td>
              <td>{{ a['male'] }}</td>
              <td>{{ a['female'] }}</td>
              <td>{{ a['children'] }}</td>
              <td>{{ a['total'] }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        </div>
      {% else %}
        <div class="empty-table">No recent attendance entries.</div>
      {% endif %}

  <script>
    (function(){
      function toInt(v){
        var n = parseInt(v);
        return isNaN(n) ? 0 : n;
      }
      function updateTotal(){
        var m = toInt(document.getElementById('male').value);
        var f = toInt(document.getElementById('female').value);
        var c = toInt(document.getElementById('children').value);
        document.getElementById('total').value = m + f + c;
      }
      ['male','female','children'].forEach(function(id){
        var el = document.getElementById(id);
        if(el){ el.addEventListener('input', updateTotal); }
      });
      // initialize
      updateTotal();
    })();
  </script>
{% endblock %}
